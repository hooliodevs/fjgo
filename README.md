# FJ Go Relay Server

Go + SQLite relay backend for `FJ Mobile IDE`.

## What it does

- Device pairing via one-time pair code
- Workspace clone management (`git clone`)
- Per-workspace git operations (status, stage, commit, push, pull, discard, log)
- Multi-session Cursor chats with persistent context
- Optional privileged-command approval workflow per session
- Real-time stream to app over WebSocket
- Message/session persistence in SQLite (WAL mode)

## Install on a server (recommended)

If `hooliodevs/fjgo` is public, this is enough:

```bash
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" | sudo bash
```

If you want to provide a GitHub token to the installer:

```bash
read -rsp "GitHub token: " GITHUB_TOKEN; echo
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" \
  | sudo GITHUB_TOKEN="$GITHUB_TOKEN" bash
```

After install, show pairing details any time with:

```bash
sudo fj-go-relay-info
```

Run full post-install diagnostics:

```bash
sudo fj-go-relay-self-check
```

Manage privileged command confirmation policy:

```bash
sudo fj-go-relay-privilege-confirmation status
sudo fj-go-relay-privilege-confirmation enable
sudo fj-go-relay-privilege-confirmation disable
sudo fj-go-relay-privilege-confirmation toggle
```

## Important server paths

Default paths created by the installer:

- Relay binary and service working directory: `/opt/fj-go-relay`
- Environment file: `/etc/fj-go-relay.env`
- SQLite database: `/var/lib/fj-go-relay/fj_relay.db`
- Workspaces root: `/var/lib/fj-go-relay/workspaces`
- Workspace clone directories: `/var/lib/fj-go-relay/workspaces/<workspace-name>-<timestamp>`

To check your active workspace root:

```bash
sudo awk -F= '/^WORKSPACES_ROOT=/{print $2}' /etc/fj-go-relay.env
```

## Restart / status / logs

```bash
sudo systemctl restart fj-go-relay
sudo systemctl status fj-go-relay --no-pager
sudo journalctl -u fj-go-relay -f
```

Service account details:

- systemd unit: `fj-go-relay.service`
- Linux user/group: `fjgo`
- Environment source: `/etc/fj-go-relay.env`
- Installer migration: if legacy `cursor`, `fjrelay`, or `fj-go-relay` users are detected, installer migrates ownership/runtime to `fjgo`.

## Health and networking checks

Local health check:

```bash
curl -s http://127.0.0.1:8787/v1/health
```

Check listener:

```bash
sudo ss -ltnp | rg 8787
```

If using UFW:

```bash
sudo ufw allow 8787/tcp
sudo ufw reload
sudo ufw status
```

## Configuration reference

All values are read from environment variables.

- `HOST` (default: `0.0.0.0`)
- `PORT` (default: `8787`)
- `DATABASE_PATH` (default: `./data/fj_relay.db`)
- `WORKSPACES_ROOT` (default: `./workspaces`)
- `DEFAULT_CURSOR_COMMAND` (default: `cursor`)
- `PAIR_CODE` (generated if omitted)
- `PAIR_CODE_TTL_MINUTES` (default: `43200`)
- `SERVER_URL` (recommended public URL, e.g. `http://<SERVER_IP>:8787`)
- `PRIVILEGE_CONFIRMATION_REQUIRED` (default: `true`)

Privilege confirmation effective behavior:

- Enabled when `PRIVILEGE_CONFIRMATION_REQUIRED=true`
- Disabled when `PRIVILEGE_CONFIRMATION_REQUIRED=false`
- Why this flag is required: it provides one clear server-level policy for whether privileged commands must be explicitly approved before they are executed.

Production installs generated by `scripts/install.sh` set:

- `DATABASE_PATH=/var/lib/fj-go-relay/fj_relay.db`
- `WORKSPACES_ROOT=/var/lib/fj-go-relay/workspaces`

## Update to latest server version

Re-run installer:

```bash
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" | sudo bash
sudo systemctl restart fj-go-relay
```

## Local development run

```bash
cp .env.example .env
go mod tidy
go run ./cmd/server
```

For local development, if `WORKSPACES_ROOT` is relative, it resolves from the process working directory.

## Runtime prerequisites

- `git` must be installed on the server host.
- `DEFAULT_CURSOR_COMMAND` must be executable by the `fjgo` user.
- Cursor must be authenticated for the service user before creating sessions:

```bash
sudo -u fjgo -H bash -lc 'cursor login'
```

If you use a custom command, login with that command path instead.

## API (v1)

- `GET /v1/health`
- `GET /v1/server/info`
- `POST /v1/pair`
- `GET /v1/server/settings/privilege-confirmation`
- `POST /v1/server/settings/privilege-confirmation`
- `GET /v1/workspaces`
- `POST /v1/workspaces/clone`
- `GET /v1/sessions`
- `POST /v1/sessions`
- `GET /v1/sessions/:id/approvals/pending`
- `POST /v1/sessions/:id/approvals`
- `POST /v1/sessions/:id/approvals/:approval_id/confirm`
- `POST /v1/sessions/:id/model`
- `GET /v1/sessions/:id/messages`
- `POST /v1/sessions/:id/input`
- `POST /v1/sessions/:id/interrupt`
- `GET /v1/sessions/:id/stream` (WebSocket)
- `GET /v1/workspaces/:id/git/status`
- `GET /v1/workspaces/:id/git/diff?file=<path>&staged=<true|false>`
- `POST /v1/workspaces/:id/git/stage`
- `POST /v1/workspaces/:id/git/unstage`
- `POST /v1/workspaces/:id/git/commit`
- `POST /v1/workspaces/:id/git/push`
- `POST /v1/workspaces/:id/git/pull`
- `POST /v1/workspaces/:id/git/discard`
- `GET /v1/workspaces/:id/git/log?limit=<n>`

## Privileged command confirmation

- Installer configures relay to run as `fjgo` with passwordless sudo access.
- Runtime prompt policy asks Cursor to list privileged commands first and wait for approval.
- Use `fj-go-relay-privilege-confirmation` to check or change this setting at any time.
