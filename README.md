# FJ Go Relay Server

Go + SQLite relay backend for `FJ Mobile IDE`.

## What it does

- Device pairing via one-time pair code
- Workspace clone management (`git clone`)
- Per-workspace git operations (status, stage, commit, push, pull, discard, log)
- Multi-session Cursor chats with persistent context
- Optional privileged-command approval workflow per session
- Real-time stream to app over WebSocket
- Message/session persistence in SQLite (WAL mode)

## Install on a server (recommended)

If `hooliodevs/fjgo` is public, this is enough:

```bash
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" | sudo bash
```

If you want to provide a GitHub token to the installer:

```bash
read -rsp "GitHub token: " GITHUB_TOKEN; echo
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" \
  | sudo GITHUB_TOKEN="$GITHUB_TOKEN" bash
```

After install, show pairing details any time with:

```bash
sudo fj-go-relay-info
```

Run full post-install diagnostics:

```bash
sudo fj-go-relay-self-check
```

Update the server later with one command:

```bash
sudo fj-go-relay-update
```

Manage privileged command confirmation policy:

```bash
sudo fj-go-relay-privilege-confirmation status
sudo fj-go-relay-privilege-confirmation enable
sudo fj-go-relay-privilege-confirmation disable
sudo fj-go-relay-privilege-confirmation toggle
```

## Important server paths

Default paths created by the installer:

- Relay binary and service working directory: `/opt/fj-go-relay`
- Environment file: `/etc/fj-go-relay.env`
- SQLite database: `/var/lib/fj-go-relay/fj_relay.db`
- Workspaces root: `/var/lib/fj-go-relay/workspaces`
- Workspace clone directories: `/var/lib/fj-go-relay/workspaces/<workspace-name>-<timestamp>`

To check your active workspace root:

```bash
sudo awk -F= '/^WORKSPACES_ROOT=/{print $2}' /etc/fj-go-relay.env
```

## Restart / status / logs

```bash
sudo systemctl restart fj-go-relay
sudo systemctl status fj-go-relay --no-pager
sudo journalctl -u fj-go-relay -f
```

Service account details:

- systemd unit: `fj-go-relay.service`
- Linux user/group: `fjgo`
- Environment source: `/etc/fj-go-relay.env`
- Installer migration: if legacy `cursor`, `fjrelay`, or `fj-go-relay` users are detected, installer migrates ownership/runtime to `fjgo`.

## Health and networking checks

Local health check:

```bash
curl -s http://127.0.0.1:8787/v1/health
```

Check listener:

```bash
sudo ss -ltnp | rg 8787
```

If using UFW:

```bash
sudo ufw allow 8787/tcp
sudo ufw reload
sudo ufw status
```

## Configuration reference

All values are read from environment variables.

- `HOST` (default: `0.0.0.0`)
- `PORT` (default: `8787`)
- `DATABASE_PATH` (default: `./data/fj_relay.db`)
- `WORKSPACES_ROOT` (default: `./workspaces`)
- `DEFAULT_CURSOR_COMMAND` (default: `cursor`)
- `PAIR_CODE` (generated if omitted)
- `PAIR_CODE_TTL_MINUTES` (default: `43200`)
- `SERVER_URL` (recommended public URL, e.g. `http://<SERVER_IP>:8787`)
- `PRIVILEGE_CONFIRMATION_REQUIRED` (default: `true`)

Privilege confirmation effective behavior:

- Enabled when `PRIVILEGE_CONFIRMATION_REQUIRED=true`
- Disabled when `PRIVILEGE_CONFIRMATION_REQUIRED=false`
- Why this flag is required: it provides one clear server-level policy for whether privileged commands must be explicitly approved before they are executed.

Production installs generated by `scripts/install.sh` set:

- `DATABASE_PATH=/var/lib/fj-go-relay/fj_relay.db`
- `WORKSPACES_ROOT=/var/lib/fj-go-relay/workspaces`

## Update to latest server version

Re-run installer:

```bash
curl -fsSL "https://raw.githubusercontent.com/hooliodevs/fjgo/main/scripts/install.sh?v=$(date +%s)" | sudo bash
sudo systemctl restart fj-go-relay
```

Shortcut (installed by the script):

```bash
sudo fj-go-relay-update
```

## Local development run

```bash
cp .env.example .env
go mod tidy
go run ./cmd/server
```

For local development, if `WORKSPACES_ROOT` is relative, it resolves from the process working directory.

## Runtime prerequisites

- `git` must be installed on the server host.
- `DEFAULT_CURSOR_COMMAND` must be executable by the `fjgo` user.
- Cursor must be authenticated for the service user before creating sessions:

```bash
sudo -u fjgo -H bash -lc 'cursor login'
```

If you use a custom command, login with that command path instead.

## API (v1)

Base URL example: `http://<SERVER_IP>:8787`

All authenticated endpoints require:

```http
Authorization: Bearer <access_token>
```

Paths are exact matches (for example, `/v1/server/settings/privilege-confirmation/` with a trailing slash returns `404`).

### Response conventions

- Most success responses are JSON.
- Most non-success responses are JSON: `{"error":"..."}`.
- Some endpoints include an optional `detail` field (for example clone failure).

### Public endpoints (no bearer required)

#### `GET /v1/health`

Returns service health.

```json
{
  "ok": true,
  "service": "fj-go-relay",
  "time": "2026-02-20T22:00:00Z"
}
```

#### `GET /v1/server/info`

Returns pairing metadata and default port.

```json
{
  "server_id": "srv_xxx",
  "pair_code_expires_at": "2026-03-22T10:00:00Z",
  "default_port": "8787"
}
```

#### `POST /v1/pair`

Pair a device and obtain access token.

Request body:

```json
{
  "pair_code": "ABC-123",
  "device_name": "My iPhone"
}
```

Success (`201`):

```json
{
  "access_token": "raw_token",
  "device_id": "uuid",
  "server_id": "srv_xxx"
}
```

Errors:

- `400` invalid body or missing fields
- `401` invalid/expired pair code
- `500` server error

### Authenticated server endpoints

#### `GET /v1/server/pairing`

Returns current pair code and expiry.

```json
{
  "pair_code": "ABC-123",
  "pair_code_expires_at": "2026-03-22T10:00:00Z"
}
```

#### `GET /v1/server/settings/privilege-confirmation`

Returns whether privileged command confirmation is required.

```json
{
  "required": true
}
```

#### `POST /v1/server/settings/privilege-confirmation`

Updates privilege confirmation requirement.

Request body:

```json
{
  "required": false
}
```

Success (`200`):

```json
{
  "required": false
}
```

### Workspace endpoints

#### `GET /v1/workspaces`

Returns all workspaces for the authenticated user.

```json
{
  "items": [
    {
      "id": "uuid",
      "user_id": "local-user",
      "name": "fj",
      "repo_url": "https://github.com/hooliodevs/fj.git",
      "local_path": "/var/lib/fj-go-relay/workspaces/fj-123",
      "status": "ready",
      "created_at": "2026-02-20T21:00:00Z"
    }
  ]
}
```

#### `POST /v1/workspaces/clone`

Clones a git repository into a new workspace.

Request body:

```json
{
  "repo_url": "https://github.com/hooliodevs/fj.git",
  "name": "fj"
}
```

`name` is optional; repo name is inferred when omitted.

Success (`201`): workspace object.

Clone failure (`400`) example:

```json
{
  "error": "git clone failed",
  "detail": "<git stderr/stdout>"
}
```

### Session endpoints

#### `GET /v1/sessions?workspace_id=<workspace_id>`

Returns sessions for user, optionally scoped to one workspace.

```json
{
  "items": [
    {
      "id": "uuid",
      "user_id": "local-user",
      "workspace_id": "uuid",
      "name": "Chat 2026-02-20 21:10",
      "launch_command": "cursor",
      "cursor_chat_id": "",
      "cursor_model": "gemini-3-flash",
      "state": "idle",
      "last_error": "",
      "created_at": "2026-02-20T21:10:00Z",
      "last_active_at": "2026-02-20T21:10:00Z"
    }
  ]
}
```

#### `POST /v1/sessions`

Creates a session.

Request body:

```json
{
  "workspace_id": "uuid",
  "name": "My Chat",
  "launch_command": "cursor",
  "model": "gemini-3-flash"
}
```

Notes:

- `workspace_id` is required.
- `name`, `launch_command`, and `model` are optional; server fills defaults.

Success (`201`): session object.

#### `DELETE /v1/sessions/:id`

Deletes a session. Success response is `204 No Content`.

#### `GET /v1/sessions/:id/messages?limit=<n>`

Returns ordered session messages.

```json
{
  "items": [
    {
      "id": "uuid",
      "session_id": "uuid",
      "role": "user",
      "content": "hello",
      "model": "",
      "created_at": "2026-02-20T21:12:00Z"
    }
  ]
}
```

`limit` defaults to `500`, max `5000`.

#### `POST /v1/sessions/:id/input`

Sends user input to running session.

Request body:

```json
{
  "content": "Explain this repository"
}
```

Success response: `202 {"ok":true}`.

If privilege confirmation is enabled and a pending approval exists, returns `409`:

```json
{
  "error": "privileged commands are pending explicit confirmation",
  "approval": { "...": "approval object" }
}
```

#### `POST /v1/sessions/:id/interrupt`

Interrupts current generation. Success: `200 {"ok":true}`.

#### `POST /v1/sessions/:id/model`

Updates active session model.

Request body:

```json
{
  "model": "gemini-3-flash"
}
```

Success response:

```json
{
  "ok": true,
  "model": "gemini-3-flash"
}
```

#### `GET /v1/sessions/:id/stream` (WebSocket)

WebSocket stream for realtime session events.

- Use bearer token in websocket headers.
- Server emits JSON events like:
  - `session_state`
  - `message_delta`
  - `message_done`
  - `error`

### Privileged approval endpoints

#### `GET /v1/sessions/:id/approvals/pending`

Returns current pending approval (or `null`).

```json
{
  "item": {
    "id": "uuid",
    "user_id": "local-user",
    "session_id": "uuid",
    "commands": ["sudo apt update"],
    "reason": "Install dependency",
    "status": "pending",
    "approval_key": "",
    "created_at": "2026-02-20T21:30:00Z"
  }
}
```

#### `POST /v1/sessions/:id/approvals`

Creates a privileged approval request.

Request body:

```json
{
  "commands": ["sudo apt update", "sudo apt install -y ripgrep"],
  "reason": "Install required tooling"
}
```

Success: `201` with approval object.

If another approval is pending: `409` with `error` + `approval`.

#### `POST /v1/sessions/:id/approvals/:approval_id/confirm`

Approves or rejects a pending request.

Request body:

```json
{
  "approve": true,
  "reviewed_by": "toby"
}
```

Success: `200` with updated approval object (approved entries include `approval_key`).

### Git endpoints

All git endpoints are under:

`/v1/workspaces/:id/git/*`

and require the workspace to exist, be accessible, and contain a `.git` directory.

#### `GET /status`

Returns branch/ahead/behind plus parsed file status.

#### `GET /diff?file=<relative_path>&staged=<true|false>`

Returns:

```json
{
  "file": "lib/main.dart",
  "staged": false,
  "diff": "<git diff text>"
}
```

#### `POST /stage`

Request body:

- stage all:

```json
{"all": true}
```

- or stage selected paths:

```json
{"paths": ["lib/main.dart", "README.md"]}
```

#### `POST /unstage`

```json
{"paths": ["lib/main.dart"]}
```

#### `POST /commit`

```json
{"message": "feat: add docs"}
```

Returns command output.

#### `POST /push`

```json
{"remote": "origin", "branch": "main"}
```

`remote` and `branch` are optional.

#### `POST /pull`

Performs `git pull --ff-only`.

#### `POST /discard`

```json
{"paths": ["lib/main.dart"]}
```

Restores tracked file state and removes untracked files/dirs for each path.

#### `GET /log?limit=<n>`

Returns commit list (`hash`, `short_hash`, `author`, `email`, `subject`, `committed_at`).
`limit` default: `20`, max: `200`.

## Privileged command confirmation

- Installer configures relay to run as `fjgo` with passwordless sudo access.
- Runtime prompt policy asks Cursor to list privileged commands first and wait for approval.
- Use `fj-go-relay-privilege-confirmation` to check or change this setting at any time.
